@using PLE444.ViewModels
@model DiscussionViewModel
@{
	ViewBag.Title = "Tartışmalar";
	Layout = "~/Views/Shared/_Layout.cshtml";

	var isCreator = Model.Role == "Creator";
}

@{ Html.RenderAction("Navigation", "Course", new { id = Model.CourseId }); }

<style>
	.unreadMessage {
		background: #ffecb3;
		box-shadow: 0 0 5px 5px #ffecb3;
		box-shadow: 0 0 5px 5px rgba(255,236,179,1);
		border-radius: 2px;
	}

	.reply {
		margin-left: 47px;
		padding: 0px 5px 0px;
		background: aliceblue;
	}

</style>

<div class="row">
	<div class="col-md-9">
		<div class="panel-group panel-default" id="accordionA">
			@{
				var orderedDiscussions = Model.Discussion.OrderBy(o => o.Topic);
			}
			@foreach (var discussion in orderedDiscussions.OrderByDescending(d => d.DateCreated)) {
				var readings = discussion.Readings.FirstOrDefault(u => u.UserId == Model.CurrentUserId);
				DateTime? lastRead = null;
				if (readings != null) {
					lastRead = readings.Date;
				}
				var unreads = new List<PLE444.Models.Message>();
				unreads = lastRead != null ? discussion.Messages.Where(d => d.DateSent > lastRead).ToList() : discussion.Messages.ToList();
				unreads = unreads.Except(discussion.Messages.Where(u => u.SenderId == Model.CurrentUserId).ToList()).ToList();

				<div class="panel panel-default">
					<a data-toggle="collapse" data-parent="#accordionA" DiscussionId="@discussion.ID" class="Discussion" href="#@discussion.ID">
						<div class="panel-heading">

							<h2>@discussion.Topic</h2>

							<div class="pull-right">
								@if (discussion.Readings.Count != 0) {
									<span>@discussion.Readings.Count kişi okudu</span>
								}

								@if (unreads.Count != 0) {
									<span class="badge badge-warning">@unreads.Count okunmamış</span>
								}
							</div>
						</div>
					</a>

					<div id="@discussion.ID" class="collapse">
						<div class="panel-body">
							<div class="message">
								@if (Model.CurrentUserId == null) {
									<p>Mesaj yollamak için yapın</p>
								}
								else {
									@Html.Partial("SendMessage", new NewMessageViewModel { DiscussionId = discussion.ID, CommunityId = Model.CourseId, CurrentUserId = Model.CurrentUserId })
								}
								@if (isCreator) {
									<a href="@Url.Action("RemoveTitle", "Course", new {discussionId = discussion.ID, courseId = Model.CourseId})">
										<small class="text-danger">Başlığı Sil</small>
									</a>
								}
							</div>

							<hr>

							@{
								string PrevUserId = "";
								var orderedMessages = discussion.Messages.OrderBy(o => o.DateSent);
								foreach (var message in orderedMessages.OrderByDescending(m => m.DateSent)) {
									var dh = new PLE444.Helpers.DataManipulationHelper();
									var isOwner = Model.CurrentUserId == message.SenderId;

									<div class="message">
										@if (message.SenderId != PrevUserId) {
											<a href="@Url.Action("Profil","User", new {id = message.SenderId})">
												<img class="img-circle" style="width:40px" src="@Url.Content(message.Sender.UserPhoto())" />
												<strong style="margin-left:10px;">@message.Sender.FullName()</strong>
											</a>
											<br>
										}
										<div class="pull-right">
											@if (isOwner || isCreator) {
												<a href="@Url.Action("RemoveMessage", "Course", new {messageId = message.ID, courseId = Model.CourseId})">
													<small class="text-danger">Kaldır</small>
												</a>

												<a class="replyBtn" data-parent-id="@message.ID" href="#"><small class="text-info">Cevapla</small></a>
											}

											<small>@dh.GetDeltaDate(message.DateSent)</small>
										</div>

										@if (unreads.FirstOrDefault(i => i.ID == message.ID) == null) {
											<div class="content" style="margin-left:50px;">@(new HtmlString(message.Content))</div>
										}
										else {
											<div class="content unreadMessage" style="margin-left:50px;">@(new HtmlString(message.Content))</div>
										}

										@foreach (var reply in message.Replies) {
											<div class="reply">
												<a href="@Url.Action("Profil","User", new {id = reply.SenderId})">
													<strong style="margin-left:10px;">@reply.Sender.FullName()</strong>
												</a>
												<div class="pull-right">
													@if (Model.CurrentUserId == reply.SenderId || isCreator) {
														<a href="@Url.Action("RemoveMessage", "Course", new {messageId = reply.ID, courseId = Model.CourseId})">
															<small class="text-danger">Kaldır</small>
														</a>
													}

													<small>@dh.GetDeltaDate(reply.DateSent)</small>
												</div>

												<div class="content">@(new HtmlString(reply.Content))</div>
											</div>
										}
									</div>

									PrevUserId = message.SenderId;
								}

							}

						</div>
					</div>
				</div>
			}
		</div>
	</div>

	<div class="col-md-3">
		<a href="@Url.Action("AddTitle", new {id = Model.CourseId})" class="btn btn-primary-alt btn-lg btn-block">
			<i class="fa fa-plus fa-bold"></i> Başlık Ekle
		</a>
	</div>
</div>

<script src="http://code.jquery.com/jquery-3.1.0.min.js"></script>

<script>
	var debugging = false;
	$('.Discussion').click(function () {
		$.ajax({
			url: '@Url.Action("Read","Course")',
			dataType: 'json',
			type: 'POST',
			data: "DiscussionId=" + $(this).attr('DiscussionId') + "&CourseId=" + "@Model.CourseId",


			success: function (data) {
				if (debugging)
					alert(data.success);
			},
			error: function () {
				if (debugging)
					alert("error");
			}
		});
	});

	$(".replyBtn").click(function (event) {
		var content = $(this).closest(".message").find(".content").html();
		var parentId = $(this).data("parent-id");

		console.log("parentId", parentId);
		console.log(content);

		$(this).closest(".panel-body").find(".replyDisplay").find(".content").html(content);
		$(this).closest(".panel-body").find(".replyDisplay").find("input[name='ReplyId']").val(parentId);

		$(this).closest(".panel-body").find(".replyDisplay").slideDown();
	});
</script>

